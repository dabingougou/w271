---
title: "W271 Assignment 8"
output: pdf_document
---

```{r load packages, message=FALSE, warning=FALSE}
library(tidyverse)
library(magrittr)
library(patchwork)

library(lubridate)

library(tsibble)
library(feasts)
library(forecast)

library(sandwich)
library(lmtest)

library(nycflights13)
library(blsR)
```

```{r set themes}
theme_set(theme_minimal())
```


# (14 points total) Question-1: Is Unemployment an Autoregressive or a Moving Average Process? 

You did work in a previous homework to produce a data pipeline that pulled the unemployment rate from official BLS sources. Reuse that pipeline to answer this final question in the homework: 

> "Are unemployment claims in the US an autoregressive or a moving average process?

\newpage
## (1 point) Part-1: Why is the distinction important? 

Why is it important to know whether a process is a $AR$ or an $MA$ (or a combination of the two) process? What changes in the ways that you would talk about the process, what changes in the ways that you would fit a model to the process, and what changes with how you would produce a forecast for this process?

### Q1P1 Answer 



## (1 point) Part-2: Pull in (and clean up) your data pipeline. 

In the previous homework, you built a data pipeline to draw data from the BLS. We are asking you to re-use, and if you think it is possible, to improve the code that you wrote for this pipeline in the previous homework. 

- Are there places where you took "shortcuts" that could be more fully developed?

- Are the processes that could be made more modular, or better documented so that they are easier for you to understand what they are doing? You've been away from the code that you wrote for a few weeks, and so it might feel like "discovering" the code of a *mad-person* (Who even wrote this???)

```{r}

huibin_bls_key <- "e943ccb8989f4599bd7964149a31457d"
bls_set_key(huibin_bls_key)
if (bls_has_key()) {
  print("Key provided. OK.")
} else {
  print("BLS API key not provided")
}

# Specify series IDs
series_id_list <- c(
  overall = "LNS14000000",
  male    = "LNS14000001",
  female  = "LNS14000002"
)

current_year <- as.numeric(format(Sys.Date(), "%Y"))
current_year

#raw_bls_data <- get_n_series_table(
#  series_ids = series_id_list,
#  api_key = bls_get_key(),
#  start_year = current_year - 20, 
#  end_year = current_year
#)

# Saved the query results so that I don't use up my api quota
saveRDS(raw_bls_data, file = "data/my_api_results.Rds")

# readRDS()

# bls_unset_key()

head(raw_bls_data)

unemployment <- 
  raw_bls_data %>%
  pivot_longer(
#    cols = c("LNS14000000", "LNS14000001"), 
    cols = starts_with("LNS"),
    names_to = "series_id",
    values_to = "value"
  ) %>%
  mutate(
    date = lubridate::ymd(paste0(year, 
                                 "-", 
                                 gsub(pattern = "M", 
                                      replacement = "",
                                      x = period),
                                 "-01"
                                 )), 
    name = case_when(
      series_id == "LNS14000000" ~ "overall",
      series_id == "LNS14000001" ~ "male",
      series_id == "LNS14000002" ~ "female",
      TRUE ~ series_id
                      )
  ) %>%
  mutate(
    year = year(date),
    month = month(date),
    time_index = yearmonth(date)
  ) %>%
  as_tsibble(
    key = name,
    index = time_index
  )

unemployment
unemployment %>%
  ggplot(aes(x = year, y = value, color = name)) +
  geom_line(line_width = 1)

```

\newpage
## (5 points) Part-3: Conduct an EDA of the data and comment on what you see. 

We have presented four **core** plots that are a part of the EDA for time-serires data. Produce each of these plots, and comment on what you see.

```{r}

unemployment %>%
  ggplot(aes(x = time_index, y = value, color = name)) +
  geom_line(line_width = 2) + 
  labs(
    title = "2005 - 2025 Unemployment by Gender",
    x = "Time"
  )


unemployment %>%
  filter(name == "overall") %>%
  ACF(
    lag_max= 60
  ) %>%
  autoplot() + 
  labs(
    title = "ACF for Overall Unemployment",
    x = "Lag in Month"
  )

```


## (1 point) Part-4: Make a Call 

Based on what you have plotted and written down in the previous section, would you say that the unemployment rate is an $AR$, $MA$ or a mix of the two?

## (6 points total) Part-5:  Estimate a model 

Report the best-fitting parameters from the best-fitting model, and then describe what your model is telling you. In this description, you should: 

- (1 point) State, and justify your model selection criteria. 
- (1 point) Interpret the model selection criteria in context of the other models that you also fitted.
- (2 points) Interpret the coefficients of the model that you have estimated. 
- (2 points) Produce and interpret the model diagnostic plots to evaluate how well your best-fitting model is performing.
- (1 (optional) point) If, after fitting the models, and interpreting their diagnostics plots, you determine that the model is doing poorly -- for example, you notice that the residuals are not following a white-noise process -- then, make a note of the initial model that you fitted then propose a change to the data or the model in order to make the model fit better. If you take this action, you should focus your interpretation of the model's coefficients on the model that you think does the best job, which might be the model after some form of variable transformation. 

# (14 Points Total) Question-2: Forecasting Inflation

The Federal Reserve tracks inflation data across countries on a monthly level.

## (1 point) Part-1: Load and Clean Data

Load the CSV provided and store the data in a useful dataframe. Check for missing values and outliers in the data. Perform any cleaning that is necessary.

Also create lagged columns for GBR and CAN and training and test datasets based on pre and post Jan 1, 2022.

## (5 points) Part-2: Produce a Model on the Training Data

1. Select inflation data for the US.
2. Produce a 7 observation lag, backward smoother of inflation and plot the original time series with its smoothed trend. 
3. Produce a time series model of inflation. This should include: 
  - Conducting a full EDA and description of the data that you observe.
  - Estimating a model that you believe is appropriate after conducting your EDA.
  - Evaluating the model performance through diagnostic plots and making any necessary adjustments to satisfy key assumptions.

## (5 points) Part-3: Leveraging Other Countries

1. Examine how correlated (lagged) GBR and CAN inflation is with the US. Do you think prior inflation data in these countries can help forecast inflation in the US?
2. Build an appropriate time series model for US inflation, leveraging prior data in the selected countries (with a wide tsibble with each country as a column, we can add additional predictors to `ARIMA()` by name like we would in `lm()`):
  - This is known as adding exogenous variables to `ARIMA()` and behind the scenes the function will estimate a linear time series model with exogenous variables as predictors, using an `ARIMA()` model for the residuals
  - Estimate a model that you believe is appropriate after conducting your EDA.
  - Evaluate the model performance through diagnostic plots and making any necessary adjustments to satisfy key assumptions.

## (3 points) Part-4: Forecasting and Model Comparison

Forecast inflation in 2022 and beyond (i.e. the test data) in the US using the various models you created. Include any models that did not necessarily satisfy the assumption of white noise in the residuals that you might have originally tried.

Which model is the best? Explain your results.
